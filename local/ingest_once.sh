#!/usr/bin/env bash
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# ingest_once.sh
#
# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è:
#   ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–≤ –∫–∞—Ç–∞–ª–æ–≥–µ –ø—Ä–æ–µ–∫—Ç–∞)
#   ‚Ä¢ –ó–∞–ø—É—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–≥–¥–µ —Ä–∞–±–æ—á–∞—è –ø–∞–ø–∫–∞ /app)
#
# –õ–æ–≥–∏–∫–∞:
#   1) –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è .env.local:
#        ‚Ä¢ –ï—Å–ª–∏ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º ‚Äî —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.
#        ‚Ä¢ –ï—Å–ª–∏ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –≤ /app/.env.local ‚Äî —ç—Ç–æ Docker-—Ä–µ–∂–∏–º.
#   2) –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ .env.local (–ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ)
#   3) –ò—â–µ–º requirements.txt:
#        ‚Ä¢ –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, –≥–¥–µ –ª–µ–∂–∏—Ç —Å–∫—Ä–∏–ø—Ç (–ª–æ–∫–∞–ª—å–Ω–æ) –∏–ª–∏ /app (Docker).
#        ‚Ä¢ –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ orchestrator.
#        ‚Ä¢ –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ —Ç–∞–º, –Ω–∏ —Ç–∞–º ‚Äî –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π.
#   4) –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ç—É –ø–∞–ø–∫—É, –≥–¥–µ –ª–µ–∂–∏—Ç requirements.txt.
#   5) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (pip install -r requirements.txt).
#   6) (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ó–∞–ø—É—Å–∫–∞–µ–º ingest_data.py.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

set -e

# 1) –ù–∞–π–¥—ë–º –ø—É—Ç—å –¥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "$0")" >/dev/null 2>&1 && pwd)"

# 2) –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å .env.local (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ Docker)
#    –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π .env.local —Ä—è–¥–æ–º —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º
if [ -f "${SCRIPT_DIR}/.env.local" ]; then
    echo "üîÑ –ù–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π .env.local –≤ ${SCRIPT_DIR}"
    export $(grep -v '^#' "${SCRIPT_DIR}/.env.local" | xargs)
#    –ó–∞–º–µ—Ç–∏–º: –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ—Å—Ç–æ export –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤).
elif [ -f "/app/.env.local" ]; then
    echo "üîÑ –ù–∞–π–¥–µ–Ω Docker-.env.local –≤ /app/.env.local"
    export $(grep -v '^#' "/app/.env.local" | xargs)
else
    echo "‚ö†Ô∏è  .env.local –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ ${SCRIPT_DIR}, –Ω–∏ –≤ /app/"
    # –ù–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã
fi

# 3) –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –∏—Å–∫–∞—Ç—å requirements.txt –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
#    –õ–æ–∫–∞–ª—å–Ω–æ: SCRIPT_DIR/requirments.txt –∏–ª–∏ SCRIPT_DIR/orchestrator/requirements.txt
#    –í Docker:     /app/requirements.txt –∏–ª–∏ /app/orchestrator/requirements.txt

if [ -f "${SCRIPT_DIR}/requirements.txt" ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω requirements.txt –≤ ${SCRIPT_DIR}"
    TARGET_DIR="${SCRIPT_DIR}"
elif [ -f "${SCRIPT_DIR}/orchestrator/requirements.txt" ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω requirements.txt –≤ ${SCRIPT_DIR}/orchestrator"
    TARGET_DIR="${SCRIPT_DIR}/orchestrator"
elif [ -f "/app/requirements.txt" ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω requirements.txt –≤ /app"
    TARGET_DIR="/app"
elif [ -f "/app/orchestrator/requirements.txt" ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω requirements.txt –≤ /app/orchestrator"
    TARGET_DIR="/app/orchestrator"
else
    echo "‚ùå requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–∏ –≤ /app/"
    exit 1
fi

# 4) –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É —Å requirements.txt
cd "${TARGET_DIR}"

# 5) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ ${TARGET_DIR}/requirements.txt..."
pip install --upgrade pip
pip install --no-cache-dir -r requirements.txt
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

# 6) –ó–∞–ø—É—Å–∫–∞–µ–º ingest_data.py, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –∏ –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ä–∞–∑—É –∏–Ω–∂–µ—Å—Ç–∏—Ç—å

 echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ ingest_data.py"
 python "${SCRIPT_DIR}/ingest_data.py" --no-video --no-jira

echo "üéâ ingest_once.sh –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É."